<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drought Intensity and City Counts</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map1, #map2 { width: 100%; height: 500px; }
    .legend { background-color: white; border-radius: 5px; padding: 10px; }
  </style>
</head>
<body>
  <h1>Drought Intensity and City Counts</h1>
  <div id="map1"></div>
  <h2>Map 1: City Counts for Any Drought (DM 2-4)</h2>
  <div id="map2"></div>
  <h2>Map 2: City Counts Normalized by Population Density</h2>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Load Turf.js from a CDN -->
  <script src="https://unpkg.com/@turf/turf"></script> 

  <script>
    const map1 = L.map('map1').setView([37.8, -96], 4);
    const map2 = L.map('map2').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map1);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map2);

    let cityData, polygonData;

    // Fetch the city data and drought data
    $.getJSON('https://raw.githubusercontent.com/aidcallahan/lab_5/main/USA_Major_Cities.geojson', function(data) {
      cityData = data;
      processData();
    });

    $.getJSON('https://raw.githubusercontent.com/aidcallahan/lab_5/main/usdm_current.json', function(data) {
      polygonData = data;
      processData();
    });

    function processData() {
      if (!cityData || !polygonData) return;

      // Filter polygons based on drought intensity (DM 2, 3, 4)
      const filteredPolygons = polygonData.features.filter(function(polygon) {
        const droughtLevel = polygon.properties.DM;
        return droughtLevel >= 2;  // Only include DM 2, 3, and 4
      });

      filteredPolygons.forEach(function(polygon) {
        polygon.cityCount = 0;

        cityData.features.forEach(function(city) {
          // Create turf point for city
          const cityPoint = turf.point(city.geometry.coordinates);

          // Check if the city point is inside the polygon (multi-polygon handling)
          polygon.geometry.coordinates.forEach(function(ring) {
            const polygonShape = turf.polygon(ring);
            if (turf.booleanPointInPolygon(cityPoint, polygonShape)) {
              polygon.cityCount += 1;
            }
          });
        });
      });

      // Add choropleth maps for the filtered polygons and city count
      const choropleth1 = L.geoJson(filteredPolygons, {
        style: function(feature) {
          return { 
            fillColor: getColor(feature.cityCount), 
            weight: 2, 
            opacity: 1, 
            color: 'white', 
            dashArray: '3', 
            fillOpacity: 0.7 
          };
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup("Drought Intensity: " + feature.properties.DM + "<br>City Count: " + feature.cityCount);
        }
      }).addTo(map1);

      const legend1 = L.control({ position: 'bottomright' });
      legend1.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<b>City Count Legend</b><br>Low: <span style="background-color:#fee5d9"></span><br>High: <span style="background-color:#f03b20"></span><br>`;
        return div;
      };
      legend1.addTo(map1);

      const choropleth2 = L.geoJson(filteredPolygons, {
        style: function(feature) {
          const normalizedValue = feature.cityCount / getPopulationDensity(feature);
          return { 
            fillColor: getColor(normalizedValue), 
            weight: 2, 
            opacity: 1, 
            color: 'white', 
            dashArray: '3', 
            fillOpacity: 0.7 
          };
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup("Drought Intensity: " + feature.properties.DM + "<br>Normalized City Count: " + (feature.cityCount / getPopulationDensity(feature)));
        }
      }).addTo(map2);

      const legend2 = L.control({ position: 'bottomright' });
      legend2.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<b>Normalized City Count Legend</b><br>Low: <span style="background-color:#fee5d9"></span><br>High: <span style="background-color:#f03b20"></span><br>`;
        return div;
      };
      legend2.addTo(map2);
    }

    function getColor(value) {
      return value > 5 ? '#800026' : value > 4 ? '#BD0026' : value > 3 ? '#E31A1C' : value > 2 ? '#FC4E2A' : value > 1 ? '#FD8D3C' : '#FFEDA0';
    }

    function getPopulationDensity(feature) {
      return feature.properties.pop_density || 1;
    }
  </script>
</body>
</html>
