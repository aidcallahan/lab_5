<script>
    const map1 = L.map('map1').setView([37.8, -96], 4);
    const map2 = L.map('map2').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map1);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map2);
  
    let cityData, polygonData;
    
    $.getJSON('https://github.com/aidcallahan/lab_5/blob/ea369cad2b27eed651260c4fb31d1cf2e0c28ae4/USA_Major_Cities.geojson', function(data) {
      cityData = data;
      processData();
    });
    
    $.getJSON('https://github.com/aidcallahan/lab_5/blob/ea369cad2b27eed651260c4fb31d1cf2e0c28ae4/usdm_current.json', function(data) {
      polygonData = data;
      processData();
    });
  
    function processData() {
      if (!cityData || !polygonData) return;
      polygonData.features.forEach(function(polygon) {
        polygon.cityCount = 0;
        cityData.features.forEach(function(city) {
          if (isPointInPolygon(city.geometry.coordinates, polygon.geometry.coordinates)) {
            polygon.cityCount += 1;
          }
        });
      });
      const choropleth1 = L.geoJson(polygonData, {
        style: function(feature) {
          return { fillColor: getColor(feature.cityCount), weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup("Drought Intensity: " + feature.properties.DM + "<br>City Count: " + feature.cityCount);
        }
      }).addTo(map1);
  
      const legend1 = L.control({ position: 'bottomright' });
      legend1.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<b>City Count Legend</b><br>Low: <span style="background-color:#fee5d9"></span><br>High: <span style="background-color:#f03b20"></span><br>`;
        return div;
      };
      legend1.addTo(map1);
  
      const choropleth2 = L.geoJson(polygonData, {
        style: function(feature) {
          const normalizedValue = feature.cityCount / getPopulationDensity(feature);
          return { fillColor: getColor(normalizedValue), weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup("Drought Intensity: " + feature.properties.DM + "<br>Normalized City Count: " + (feature.cityCount / getPopulationDensity(feature)));
        }
      }).addTo(map2);
  
      const legend2 = L.control({ position: 'bottomright' });
      legend2.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<b>Normalized City Count Legend</b><br>Low: <span style="background-color:#fee5d9"></span><br>High: <span style="background-color:#f03b20"></span><br>`;
        return div;
      };
      legend2.addTo(map2);
    }
  
    function isPointInPolygon(point, polygon) {
      const x = point[0], y = point[1];
      const inside = polygon[0].some(function(coord, i, arr) {
        return coord[0] <= x && coord[1] <= y;
      });
      return inside;
    }
  
    function getColor(value) {
      return value > 5 ? '#800026' : value > 4 ? '#BD0026' : value > 3 ? '#E31A1C' : value > 2 ? '#FC4E2A' : value > 1 ? '#FD8D3C' : '#FFEDA0';
    }
  
    function getPopulationDensity(feature) {
      return feature.properties.pop_density || 1;
    }
  </script>
  