<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drought Intensity and City Counts</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map1, #map2 { width: 100%; height: 500px; }
    .legend { background-color: white; border-radius: 5px; padding: 10px; }
  </style>
</head>
<body>
  <h1>Drought Intensity and City Counts</h1>
  <div id="map1"></div>
  <h2>Map 1: City Counts for Any Drought (DM 2-4)</h2>
  <div id="map2"></div>
  <h2>Map 2: City Counts Normalized by Population Density</h2>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/turf@6.5.0/turf.min.js"></script>
  <script>
    const map1 = L.map('map1').setView([37.8, -96], 4);
    const map2 = L.map('map2').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map1);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map2);

    let cityData, polygonData;

    $.getJSON('https://raw.githubusercontent.com/aidcallahan/lab_5/main/USA_Major_Cities.geojson', function(data) {
      cityData = data;
      console.log("City Data:", cityData);  // Debugging line
      processData();
    });

    $.getJSON('https://raw.githubusercontent.com/aidcallahan/lab_5/main/usdm_current.json', function(data) {
      polygonData = data;
      console.log("Polygon Data:", polygonData);  // Debugging line
      processData();
    });

    function processData() {
      if (!cityData || !polygonData) return;

      // Filter polygons based on drought intensity (DM 2, 3, 4)
      const filteredPolygons = polygonData.features.filter(function(polygon) {
        const droughtLevel = polygon.properties.DM;
        return droughtLevel >= 2;  // Only include DM 2, 3, and 4
      });

      filteredPolygons.forEach(function(polygon) {
        polygon.cityCount = 0;

        cityData.features.forEach(function(city) {
          // Convert city coordinates to [longitude, latitude] format for turf.js compatibility
          const cityPoint = turf.point([city.geometry.coordinates[0], city.geometry.coordinates[1]]);

          // Handle MultiPolygon (Polygon that has multiple rings)
          if (polygon.geometry.type === "MultiPolygon") {
            polygon.geometry.coordinates.forEach(function(ring) {
              const polygonFeature = turf.polygon(ring);

              // Check if the city point is inside any of the polygons (rings)
              if (turf.booleanPointInPolygon(cityPoint, polygonFeature)) {
                polygon.cityCount += 1;
              }
            });
          } else if (polygon.geometry.type === "Polygon") {
            // Handle single Polygon
            const polygonFeature = turf.polygon(polygon.geometry.coordinates);

            // Check if the city point is inside the polygon
            if (turf.booleanPointInPolygon(cityPoint, polygonFeature)) {
              polygon.cityCount += 1;
            }
          }
        });

        console.log("Polygon ID: ", polygon.properties.GEOID, "City Count: ", polygon.cityCount); // Debugging line
      });

      const choropleth1 = L.geoJson(filteredPolygons, {
        style: function(feature) {
          return { 
            fillColor: getColor(feature.properties.DM), 
            weight: 2, 
            opacity: 1, 
            color: 'white', 
            dashArray: '3', 
            fillOpacity: 0.7 
          };
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup("Drought Intensity: " + feature.properties.DM + "<br>City Count: " + feature.cityCount);
        }
      }).addTo(map1);

      const legend1 = L.control({ position: 'bottomright' });
      legend1.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<b>City Count Legend</b><br>Low: <span style="background-color:#fee5d9"></span><br>High: <span style="background-color:#f03b20"></span><br>`;
        return div;
      };
      legend1.addTo(map1);

      const choropleth2 = L.geoJson(filteredPolygons, {
        style: function(feature) {
          const normalizedValue = feature.cityCount / getPopulationDensity(feature);
          return { 
            fillColor: getColor(normalizedValue), 
            weight: 2, 
            opacity: 1, 
            color: 'white', 
            dashArray: '3', 
            fillOpacity: 0.7 
          };
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup("Drought Intensity: " + feature.properties.DM + "<br>Normalized City Count: " + (feature.cityCount / getPopulationDensity(feature)));
        }
      }).addTo(map2);

      const legend2 = L.control({ position: 'bottomright' });
      legend2.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<b>Normalized City Count Legend</b><br>Low: <span style="background-color:#fee5d9"></span><br>High: <span style="background-color:#f03b20"></span><br>`;
        return div;
      };
      legend2.addTo(map2);
    }

    function getColor(droughtLevel) {
      switch(droughtLevel) {
        case 4: return '#f03b20'; // Worst
        case 3: return '#fc4e2a';
        case 2: return '#fd8d3c';
        default: return '#bdbdbd'; // No drought
      }
    }

    function getPopulationDensity(feature) {
      return feature.properties.pop_density || 1;
    }
  </script>
</body>
</html>
